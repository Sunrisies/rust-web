# 系统架构说明

## 整体架构

本项目采用分层架构设计，主要分为以下几层：

```
┌─────────────────┐
│    API Layer    │ ← HTTP请求/响应处理
├─────────────────┤
│  Service Layer  │ ← 业务逻辑处理
├─────────────────┤
│    Data Layer   │ ← 数据访问和持久化
└─────────────────┘
```

### API 层
- 处理 HTTP 请求和响应
- 请求参数验证
- 路由管理
- 错误处理和响应格式化
- 中间件集成（认证、日志等）

### 服务层
- 实现核心业务逻辑
- 事务管理
- 数据验证和转换
- 业务规则实施
- 跨实体业务流程

### 数据层
- 数据库操作封装
- 数据模型定义
- 查询优化
- 数据缓存

## 核心组件

### 认证系统
```
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│  JWT Token   │ ←→ │Auth Middleware│ ←→ │  User Info   │
└──────────────┘    └──────────────┘    └──────────────┘
```

- JWT 基于 RS256 算法
- 支持 Token 刷新
- Google Authenticator 双因素认证
- 基于角色的访问控制（RBAC）

### 实时通知系统
```
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│  SSE Client  │ ←→ │  SSE Server  │ ←→ │Event Producer│
└──────────────┘    └──────────────┘    └──────────────┘
```

- 基于 Server-Sent Events (SSE)
- 支持多客户端订阅
- 事件过滤和分发
- 自动重连机制

### 数据库设计
```
┌──────────────┐    ┌──────────────┐
│  Connection  │ ←→ │  Connection  │
│    Pool      │    │   Manager    │
└──────────────┘    └──────────────┘
```

- MySQL 连接池管理
- 预编译语句缓存
- 事务管理
- 查询优化

## 中间件架构

### 认证中间件
- JWT Token 验证
- 权限检查
- 用户会话管理

### 日志中间件
- 请求日志记录
- 错误日志记录
- 性能监控

### CORS 中间件
- 跨域请求处理
- 预检请求处理
- 安全头部设置

## 错误处理

采用统一的错误处理机制：

```rust
#[derive(Error, Debug)]
pub enum AppError {
    #[error("Authentication error: {0}")]
    AuthError(String),
    #[error("Database error: {0}")]
    DbError(#[from] sqlx::Error),
    #[error("Validation error: {0}")]
    ValidationError(String),
    // ... 其他错误类型
}
```

- 统一的错误响应格式
- 错误类型映射
- 详细的错误信息
- 错误追踪和日志记录

## 安全设计

### 认证安全
- JWT Token 加密
- 密码哈希（Argon2）
- 双因素认证
- 会话管理

### 数据安全
- 参数验证和清理
- SQL 注入防护
- XSS 防护
- CSRF 防护

### 网络安全
- HTTPS 支持
- 安全头部配置
- 速率限制
- IP 过滤

## 性能优化

### 数据库优化
- 连接池管理
- 查询缓存
- 索引优化
- 批量操作

### API 优化
- 响应压缩
- 缓存控制
- 异步处理
- 负载均衡

## 监控和日志

### 系统监控
- 性能指标收集
- 资源使用监控
- 错误率监控
- 响应时间监控

### 日志记录
- 访问日志
- 错误日志
- 审计日志
- 性能日志

## 扩展性设计

### 水平扩展
- 无状态设计
- 会话共享
- 负载均衡
- 数据分片

### 垂直扩展
- 模块化设计
- 插件系统
- 配置中心
- 服务发现

## 部署架构

### 开发环境
- 本地开发配置
- 测试数据库
- 调试工具
- 热重载

### 生产环境
- Docker 容器化
- 负载均衡
- 监控系统
- 备份系统